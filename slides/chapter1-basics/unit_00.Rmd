---
title: "0. Setup Python"
subtitle: "Machine Learning and Deep Learning with Python"
author: "Dr. Ludwig Bothmann, Dr. Matthias AÃŸenmacher"
date: "April 29, 2022"
output:
 beamer_presentation: default
 ioslides_presentation: default
urlcolor: orange
linkcolor: orange
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(reticulate)
# Python 3
#use_python('/Users/omid/opt/anaconda3/bin/python')
#use_python('/home/ludwig/anaconda3/bin/python')
```

## 0. Installation of Python

Python can be installed in many ways, e.g. by

- .. directly downloading it from \texttt{python.org}: https://www.python.org/downloads/
- .. downloading Miniconda: https://docs.conda.io/en/latest/miniconda.html
- .. installing Python via the Anaconda distribution: https://docs.anaconda.com/anaconda/install/

## 0. Package management in Python

Unlike in R/RStudio (which you might be used to), package management in Python is a little more of a mess:  
There are *two* (concurring) package management systems:

- \texttt{pip} (+ PyPi)
- \texttt{conda} (+ Anaconda repository)

\centering
\includegraphics[width=0.45\textwidth]{conda.png}
\includegraphics[width=0.45\textwidth]{pip.png}  

## 0. Package management in Python

Key facts (\texttt{pip})

- Installs packages from the [Python Package Index (PyPi)](https://pypi.org/)
- Pip packages are source distributions (compiler needed) or wheels\footnote{tl;dr: wheels are smaller + install faster than a source distribution and do not require a compiler}
- Installs dependencies in a recursive, serial loop
- Limited to Python software
- No built-in support for **virtual environments** (but possible)
- $>$ 150k packages available on PyPi

## 0. Package management in Python

Key facts (\texttt{conda})

- Installs packages from the [Anaconda repository](https://repo.anaconda.com/)
- Conda packages are binaries, no need for compilers
- SAT solver to verify requirements of all packages
- Not limited to Python software
- Easier to create/manage **virtual environments**
- $\sim$ 1.5k packages available in the Anaconda repository

## 1. Python via the console

- Start Python in Terminal / Console / Command Line

\scriptsize
```{bash, echo=TRUE, eval=FALSE}
python
```
\normalsize

- Approximate result:

\includegraphics[width=0.95\textwidth]{python_terminal.png}

- Similar to R console:

\scriptsize
```{python, echo=TRUE}
1+1
```
\normalsize

- Exit with Ctrl-D or

\scriptsize
```{python, echo=TRUE, eval=FALSE}
exit()
```

## 2. Anaconda

Anaconda is a widely used open-source distribution of Python: 
https://www.anaconda.com

\centering
\includegraphics[width=0.5\textwidth]{anaconda.png}

## 3. Miniconda 

We recommend downloading and installing *Miniconda*, since it

- .. directly brings \texttt{conda} (as well as \texttt{pip})
- .. is a minimal installer (only the core parts, unlike Anaconda)

\centering
\includegraphics[width=0.8\textwidth]{miniconda.png}

\tiny Source: [https://www.mrdbourke.com/](https://www.mrdbourke.com/get-your-computer-ready-for-machine-learning-using-anaconda-miniconda-and-conda/)

## 4. Spyder

[Spyder](https://www.spyder-ide.org) is a complete IDE for Python (very similar to RStudio)

\centering
\includegraphics[width=0.5\textwidth]{spyder.png}

- It directly comes with the Anaconda distribution
- It can also be installed from https://www.spyder-ide.org/

## 5. Jupyter Notebooks/Lab

A Jupyter Notebook is a slightly different way of writing and presenting Python codes. It is a web application that lets you develop Python code in your browser.  
Useful for explorative analyses and for beginning stages of a project, where you need frequent feedback.

\centering
\includegraphics[width=0.3\textwidth]{jupyter.jpg}

```{bash, echo=TRUE, eval=FALSE}
conda install jupyterlab
```

## 5. Jupyter Notebooks/Lab

- Code cells vs. Markdown cells

\centering
\includegraphics[width=.7\textwidth]{jupyter1.png}

- Creating e.g. figures

\centering
\includegraphics[width=.7\textwidth]{jupyter2.png}

## 5. Jupyter Notebooks/Lab

- When you click into a cell and you see your cursor, then you are in **Edit Mode**
- Write your Code/Explanations and execute with \texttt{Ctrl+Enter}
- Hit \texttt{Esc}: Cursor disappears, cell is still selected  
  (you are in **Command mode** now)
- Now there are, among others, certain shortcuts available:
    - \texttt{A} will insert a new cell *above* the current one
    - \texttt{B} will insert one *below*
    - \texttt{C} copies the selected cell
    - \texttt{X} cuts the selected cell
    - \texttt{V} pastes copied/cut cell below
    - \texttt{M} switches the cell mode to *Markdown*
    - \texttt{Y} switches it to *Code*
    - \texttt{Up} selects cell above
    - \texttt{Down} selects cell below

## 6. RStudio

It is (meanwhile) also possible to use good old RStudio as an IDE for writing Python code:  

\centering
\includegraphics[width=0.5\textwidth]{rstudio.png}

- Install the \texttt{reticulate} packages in R
- Select the desired Python interpreter at  
  \texttt{Tools > Global Options > Python}
- \texttt{New File > Python Script}

## 6. RStudio

You can also use Python in conjunction with R Markdown  
(as you will observe quite often in our slides)

```{python, echo=TRUE}
import pandas as pd

x = pd.DataFrame({"a": [1,2,3,4],
                  "b": ["c", "d", "e", "f"]})
x
```

## 7. Virtual Environments

Assume the following scenario:

- We have two ongoing projects, \texttt{Project A} and \texttt{Project B}
- Both projects need some package \texttt{pkg\_xy}
- \texttt{Project A} needs \texttt{v1.2.0} while \texttt{Project B} requires \texttt{v2.1.3}
- What can we do about this???

\vspace{.2cm}

Solution: **Work with virtual environments**

- You can also tell RStudio to activate environments automatically by ticking the box at:  
- [x] \footnotesize \texttt{Automatically activate project-local Python environments}

## 7. Virtual Environments

Virtual Environments allow you to 

- .. have different entire version of Python running on your machine (\texttt{Python 2}, \texttt{Python 3.x}, \texttt{Python 3.y}, ..)
- .. maintain different versions of packages for your projects

\vspace{.3cm}

They can be created/activated/deactivated via

```{bash, echo=TRUE, eval=FALSE}
conda create --name some_name python=3.9
conda activate some_name
conda deactivate some_name
```

Useful commands: [Conda Cheat Sheet](https://docs.conda.io/projects/conda/en/4.6.0/_downloads/52a95608c49671267e40c689e0bc00ca/conda-cheatsheet.pdf)

## 7. Virtual Environments

- Different versions of Python

\centering
\includegraphics[width=.8\textwidth]{envs.png}

- Different (versions of) packages

\centering
\includegraphics[width=.8\textwidth]{envs2.png}

## 8. Managing packages

- Via \texttt{conda}:

```{bash, echo=TRUE, eval=FALSE}
conda install pandas
conda install pandas==1.3.5
conda update pandas
conda remove pandas
conda list
```

- Via \texttt{pip}:

```{bash, echo=TRUE, eval=FALSE}
pip install pandas
pip install pandas==1.3.5
pip install pandas --upgrade
pip uninstall pandas
pip freeze
```

## 8. Managing packages

Instruct \texttt{conda} which version you want to have installed:

- Exact (1.3.5)

```{bash, echo=TRUE, eval=FALSE}
conda install pandas==1.3.5
```

- Fuzzy (1.3.0, 1.3.1, etc.)

```{bash, echo=TRUE, eval=FALSE}
conda install pandas=1.3
```

- Greater or equal (1.3.5 or higher)

```{bash, echo=TRUE, eval=FALSE}
conda install "pandas>=1.3.5"
```

- OR (1.3.4 or 1.3.5)

```{bash, echo=TRUE, eval=FALSE}
conda install "pandas==1.3.4|1.3.5"
```

- AND (1.3.3, 1.3.4, but not 1.4)

```{bash, echo=TRUE, eval=FALSE}
conda install "pandas>=1.3.3,<1.4"
```

## 9. Reproducibility

Creating isolated environments and running different versions of Python as well
as different packages (or versions) of them works perfectly fine *(for us)*.  

What if we want to share our code with others? Make it publicly available? Across platforms?  

There needs to be some standardized way to do so, right?\footnote{Rhetorical question ;-)}

- \texttt{environment.yml} (conda)
- \texttt{requirements.txt} (pip)

## 9. Reproducibility

- Create an environment:\footnote{Note, that \texttt{-n} is the short version of the \mbox{\texttt{-}}\texttt{-name} flag}  
  (with specific Python version and some packages)  \vspace{.2cm}

\footnotesize

```{bash, echo=TRUE, eval=FALSE}
conda create -n my_env python=3.7 pandas numpy scikit-learn
```

\normalsize

- Activate the conda environment:  \vspace{.2cm}

\small
```{bash, echo=TRUE, eval=FALSE}
conda activate my_env
```

\normalsize

- Export the specifications of your conda environment:  \vspace{.2cm}

\small
```{bash, echo=TRUE, eval=FALSE}
conda env export > environment.yml
```

## 9. Reproducibility

- Result (abbreviated to fit on the slide):  \vspace{.2cm}

\scriptsize
```{bash, echo=TRUE, eval=FALSE}
name: my_env
channels:
  - defaults
dependencies:
  - blas=1.0=mkl
  - bottleneck=1.3.2=py37h2a96729_1
  - ...
  - numpy=1.21.2=py37hfca59bb_0
  - numpy-base=1.21.2=py37h0829f74_0
  - openssl=1.1.1l=h2bbff1b_0
  - packaging=21.3=pyhd3eb1b0_0
  - pandas=1.3.4=py37h6214cd6_0
  - pip=21.2.4=py37haa95532_0
  - pyparsing=3.0.4=pyhd3eb1b0_0
  - python=3.7.11=h6244533_0
  - python-dateutil=2.8.2=pyhd3eb1b0_0
  - pytz=2021.3=pyhd3eb1b0_0
  - scikit-learn=1.0.1=py37hf11a4ad_0
  - scipy=1.7.1=py37hbe87c03_2
  - ...
prefix: C:\Users\ri85vex\Miniconda3\envs\my_env
```

## 9. Reproducibility

- *Note 1*: As you can see, this also includes all sorts of packages that are automatically
  installed when creating an environment

- *Note 2*: We observe some cryptic stuff after the version of each package 

- *Note 3*: Those packages installed via pip are **also handled by this file** (see next slide)

- *Note 4*: The \texttt{prefix} is ignored when using the \texttt{.yml}-file for creation.
  So you can simply delete it after the export.

## 9. Reproducibility

- Install some package via \texttt{pip}:  \vspace{.2cm}

\small
```{bash, echo=TRUE, eval=FALSE}
pip install matplotlib
```

- Result (abbreviated to fit on the slide):  \vspace{.2cm}

\tiny
```{bash, echo=TRUE, eval=FALSE}
name: my_env
channels:
  - defaults
dependencies:
  - blas=1.0=mkl
  - bottleneck=1.3.2=py37h2a96729_1
  - ca-certificates=2021.10.26=haa95532_2
  - certifi=2021.10.8=py37haa95532_0
  - icc_rt=2019.0.0=h0cc432a_1
  - intel-openmp=2021.4.0=haa95532_3556
  - ...
  - pip:
    - cycler==0.11.0
    - fonttools==4.28.5
    - kiwisolver==1.3.2
    - matplotlib==3.5.1
    - pillow==9.0.0
prefix: C:\Users\ri85vex\Miniconda3\envs\my_env

```

## 9. Reproducibility

- Using the ``--from-history`` flag  \vspace{.2cm}

\footnotesize

```{bash, echo=TRUE, eval=FALSE}
conda env export --from-history > environment.yml
```

\normalsize

.. allows you to create a reduced version of the \texttt{.yml}-file containing only the packages (+ version) you explicitly installed (**via conda**):  \vspace{.2cm}

\small
```{bash, echo=TRUE, eval=FALSE}
name: my_env
channels:
  - defaults
dependencies:
  - scikit-learn
  - numpy
  - python=3.7
  - pandas
prefix: C:\Users\ri85vex\Miniconda3\envs\my_env
```
  
## 9. Reproducibility

- Export specifications of the \texttt{pip} packages:  \vspace{.2cm}

\small
```{bash, echo=TRUE, eval=FALSE}
pip freeze > requirements.txt
```

\normalsize

- Can be installed in a conda environment via:  \vspace{.2cm}

\small
```{bash, echo=TRUE, eval=FALSE}
pip install -r requirements.txt
```

\normalsize

- **But**: Requiring others to execute these two steps is cumbersome!

## 9. Reproducibility

- Best practice: Create \texttt{.yml}-file manually  \vspace{.2cm}

\footnotesize
```{bash, echo=TRUE, eval=FALSE}
name: my_env
channels:
  - defaults
dependencies:
  - python=3.7.11
  - numpy=1.21.2
  - pandas=1.3.4
  - scikit-learn=1.0.1
  - pip=21.2.4
  - pip:
    # works for regular pip packages
    - matplotlib==2.0.0
    # also works for whole requirements-files:
    - -r requirements.txt
```

\normalsize

- Finally: Create environment from \texttt{.yml}-file:  \vspace{.2cm}

\small
```{bash, echo=TRUE, eval=FALSE}
conda env create -f environment.yml
```